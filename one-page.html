<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../neon-animation/neon-animatable-behavior.html">
<link rel="import" href="../neon-animation/neon-animation.html">

<dom-module id="one-page">
    <template>
        <app-location route="{{route}}"></app-location>
        <div>
            <slot></slot>
        </div>
    </template>

    <script>

        Polymer({
            is: 'one-page',
            behaviors: [
                Polymer.NeonAnimationRunnerBehavior
            ],
            properties: {
                //The url of the file for lazy loading
                fileUrl: {
                    type: String
                },
                //Url for the element to be active
                activeUrl: {
                    type: String
                },
                //TODO: Handle patterns for complex routing
                pattern: {
                    type: String,
                    readOnly: true
                },
                //Default page when url is '/'
                default: {
                    type: Boolean,
                    value: false
                },
                //Level of indentation of url: E.g: /home === 1. /home/cars === 2. /home/cars/ferrari === 3...
                index: {
                    type: Number
                },
                //Whether the page is currently opened
                opened: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_openedChanged'
                },
                entryAnimation: {
                    value: 'scale-up-animation'
                },
                exitAnimation: {
//                    value: 'fade-out-animation'
                }
            },

            observers: [
                '_routePageChanged(route.path)'
            ],
            listeners: {
                'neon-animation-finish': '_onNeonAnimationFinish'
            },
            _onNeonAnimationFinish: function() {
                if (!this.opened) {
                    this.style.display = 'none';
                }
            },
            _openedChanged: function () {
                if(this.opened) {
                    this.style.display = 'block';
                    this.playAnimation('entry');
                }
                else {
                    this.playAnimation('exit');
                }
            },

            //Executed when the url changes
            _routePageChanged: function(path) {
                if(!this.activeUrl) return;

                //When page is default
                if((!path || path === '/') && this.activeUrl && this.activeUrl !== '/' && this.default) {
                    this.set('route.path', this.activeUrl);
                    return;
                }

                //Extract path depending on index
                if(this.index) path = path.split('/')[this.index];

                //Display when activeUrl matches path
                if(path === this.activeUrl) {
                    if(this.fileUrl) this.importHref(this.resolveUrl('../../src/' + this.fileUrl), null, null, true);
                    this.opened = true;
                }

                //Hide when activeUrl doesn't match path
                else if(this.activeUrl) {
                    this.opened = false;
                }
            }
        });

    </script>

</dom-module>
